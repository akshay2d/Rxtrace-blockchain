// -----------------------------------
// DATABASE CONNECTION
// -----------------------------------
datasource db {
  provider = "postgresql"
  schemas  = ["public", "auth"]
}

// -----------------------------------
// PRISMA CLIENT GENERATOR
// -----------------------------------
generator client {
  provider = "prisma-client-js"
}

// -----------------------------------
// COMPANY WALLET (Credit System)
// -----------------------------------
model company_wallets {
  company_id    String   @id
  balance       Float    @default(0)
  credit_limit  Float    @default(10000)
  status        String   @default("ACTIVE") // ACTIVE | FROZEN
  updated_at    DateTime @updatedAt

  @@schema("public")
}

// -----------------------------------
// ACTIVE PAID HEADS (Modules)
// -----------------------------------
model company_active_heads {
  company_id String   @id
  heads      Json     @default("{}") // Example: { scan: true, seat: false, ... }
  updated_at DateTime @updatedAt

  @@schema("public")
}

// -----------------------------------
// BILLING TRANSACTIONS (Audit Log)
// -----------------------------------
model billing_transactions {
  id             String   @id @default(uuid())
  company_id     String
  type           String   // scan | generation | handset | seat | topup
  subtype        String?  // box | carton | pallet etc.
  count          Int      @default(1)
  amount         Float    // total charged
  balance_after  Float    // wallet balance after deduction
  created_at     DateTime @default(now())

  @@index([company_id])
  @@schema("public")
}

// -----------------------------------
// HANDSET ALLOCATION (For scanning)
// -----------------------------------
model company_handsets {
  id             String   @id @default(uuid())
  company_id     String
  handset_id     String
  active         Boolean  @default(true)
  activated_at   DateTime @default(now())
  deactivated_at DateTime?
  monthly_fee    Float    @default(100)

  @@index([company_id])
  @@schema("public")
}

// -----------------------------------
// SEAT ALLOCATION (For code generation)
// -----------------------------------
model company_seats {
  id             String   @id @default(uuid())
  company_id     String
  seat_id        String
  active         Boolean  @default(true)
  activated_at   DateTime @default(now())
  deactivated_at DateTime?
  monthly_fee    Float    @default(200)

  @@index([company_id])
  @@schema("public")
}

// -----------------------------------
// HANDSET TOKENS (For activation)
// -----------------------------------
model handset_tokens {
  id         String   @id @default(uuid())
  company_id String
  token      String   @unique
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  @@index([company_id])
  @@schema("public")
}

// -----------------------------------
// SCAN EVENTS (Scan history log)
// -----------------------------------
model scan_events {
  id          String   @id @default(uuid())
  company_id  String
  handset_id  String
  scan_value  String
  scan_type   String   // unit | box | carton | pallet
  created_at  DateTime @default(now())

  @@index([company_id])
  @@index([handset_id])
  @@schema("public")
}

// -----------------------------------
// HANDSETS (Registered devices)
// -----------------------------------
model handsets {
  id                 String   @id @default(uuid())
  company_id         String
  device_fingerprint String   @unique
  role               String   // "UNIT_ONLY" | "HIGH_SCAN"
  status             String   @default("ACTIVE")
  created_at         DateTime @default(now())

  @@index([company_id])
  @@schema("public")
}

model pallet {
  sscc         String   @id
  company_id   String
  created_at   DateTime @default(now())
  status       String   @default("ACTIVE") // ACTIVE / SHIPPED / CLOSED
  cartons      carton[] // relation

  @@schema("public")
}

model carton {
  sscc         String   @id
  company_id   String
  pallet_id    String?
  pallet       pallet?  @relation(fields: [pallet_id], references: [sscc])
  created_at   DateTime @default(now())
  status       String   @default("ACTIVE")
  boxes        box[]

  @@schema("public")
}

model box {
  sscc         String   @id
  company_id   String
  carton_id    String?
  carton       carton? @relation(fields: [carton_id], references: [sscc])
  created_at   DateTime @default(now())
  status       String   @default("ACTIVE")
  units        unit[]

  @@schema("public")
}

model unit {
  uid          String   @id
  company_id   String
  box_id       String?
  box          box?     @relation(fields: [box_id], references: [sscc])
  created_at   DateTime @default(now())
  status       String   @default("ACTIVE")

  @@schema("public")
}

// -----------------------------------
// PACKING RULES (SSCC Hierarchy)
// -----------------------------------
model packing_rules {
  id                       String   @id @default(uuid())
  sku_id                   String
  version                  Int      @default(1)
  name                     String?
  strips_per_box           Int
  boxes_per_carton         Int
  cartons_per_pallet       Int
  allow_partial_last_container Boolean @default(true)
  sscc_extension_digit     Int      @default(0) @db.SmallInt
  sscc_company_prefix      String
  sscc_sequence_key        String
  meta                     Json     @default("{}")
  created_by               String?
  created_at               DateTime @default(now())

  @@unique([sku_id, version])
  @@schema("public")
}

model sscc_counters {
  sequence_key String   @id
  last_serial  BigInt   @default(0)
  updated_at   DateTime @default(now())

  @@schema("public")
}

model pallets {
  id               String    @id @default(uuid())
  company_id       String
  sku_id           String?
  packing_rule_id  String?
  sscc             String    @unique @db.VarChar(18)
  sscc_with_ai     String?
  meta             Json      @default("{}")
  created_by       String?
  created_at       DateTime  @default(now())
  cartons          cartons[]

  @@schema("public")
}

model cartons {
  id          String   @id @default(uuid())
  company_id  String
  pallet_id   String?
  pallet      pallets? @relation(fields: [pallet_id], references: [id], onDelete: SetNull)
  sku_id      String?
  code        String
  meta        Json     @default("{}")
  created_by  String?
  created_at  DateTime @default(now())

  @@schema("public")
}
